package com.narvar.pulsar.function;

import com.narvar.pulsar.exception.BadStatusException;
import org.apache.http.StatusLine;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.pulsar.functions.api.Context;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.junit.platform.runner.JUnitPlatform;
import org.junit.runner.RunWith;
import org.mockito.Mockito;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.concurrent.CompletableFuture;

import static com.narvar.pulsar.constant.FunctionConstants.*;
import static org.junit.jupiter.api.Assertions.assertNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.mockito.Mockito.*;

@RunWith(JUnitPlatform.class)
class RedirectToExceptionFunctionTest {

    private static Context context = mock(Context.class);
    private static RedirectToExceptionFunction spyFunction = Mockito.spy(RedirectToExceptionFunction.class);
    private static StatusLine statusLine = mock(StatusLine.class);

    @BeforeAll
    static void setUp() throws IOException {

        Logger logger = LoggerFactory.getLogger(RedirectToExceptionFunctionTest.class);
        when(context.getLogger()).thenReturn(logger);

        String outputTopic = "persistent://public/default/exception-output";
        when(context.getOutputTopic()).thenReturn(outputTopic);

        CompletableFuture<Void> future = mock(CompletableFuture.class);
        when(context.publish(anyString(), anyString())).thenReturn(future);

        CloseableHttpClient mockClient = mock(CloseableHttpClient.class);
        when(spyFunction.buildHttpClient()).thenReturn(mockClient);
        CloseableHttpResponse response = mock(CloseableHttpResponse.class);
        when(mockClient.execute(any(HttpPost.class))).thenReturn(response);

        when(response.getStatusLine()).thenReturn(statusLine);
        StringEntity entity = new StringEntity("Gateway response");
        when(response.getEntity()).thenReturn(entity);
    }

    @Test
    public void send_payload_to_gateway() throws Exception {
        when(statusLine.getStatusCode()).thenReturn(200);
        String gatewayUrl = "http://unit-test/post";
        String payload = "{\"previous_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"XYZZZZ\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"XYZZZZ\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-10-30T17:50:52.692Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"merged_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"xyzzzz\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"xyzzzz\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-11-02T05:54:19.326Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-11-02T05:54:19.323Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("700");
        when(context.getUserConfigValueOrDefault(API_GATEWAY_URL, DEFAULT_API_GATEWAY_URL)).thenReturn(gatewayUrl);
        Void object = spyFunction.process(payload, context);
        assertNull(object);
    }

    @Test
    void do_not_send_payload_to_gateway() throws Exception {
        String payload = "{\"previous_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"XYZZZZ\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"XYZZZZ\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-10-30T17:50:52.692Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"merged_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"xyzzzz\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"xyzzzz\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-11-02T05:54:19.326Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-11-02T05:54:19.323Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("500");
        Void object = spyFunction.process(payload, context);
        assertNull(object);
    }

    @Test
    void no_gateway_provided() throws Exception {
        String payload = "{\"previous_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"XYZZZZ\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"XYZZZZ\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-10-30T17:50:52.692Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"merged_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"xyzzzz\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"xyzzzz\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-11-02T05:54:19.326Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-11-02T05:54:19.323Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("700");
        when(context.getUserConfigValueOrDefault(API_GATEWAY_URL, DEFAULT_API_GATEWAY_URL)).thenReturn(DEFAULT_API_GATEWAY_URL);
        Void object = spyFunction.process(payload, context);
        assertNull(object);
    }

    @Test
    void no_merged_order_tracking_response() throws Exception {
        when(statusLine.getStatusCode()).thenReturn(200);
        String gatewayUrl = "http://unit-test/post";
        String payload = "{\"previous_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"XYZZZZ\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"XYZZZZ\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-10-30T17:50:52.692Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("700");
        when(context.getUserConfigValueOrDefault(API_GATEWAY_URL, DEFAULT_API_GATEWAY_URL)).thenReturn(gatewayUrl);
        Void object = spyFunction.process(payload, context);
        assertNull(object);
    }

    @Test
    void no_order_tracking_response() {
        String payload = "{\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("700");
        when(context.getUserConfigValueOrDefault(API_GATEWAY_URL, DEFAULT_API_GATEWAY_URL)).thenReturn(DEFAULT_API_GATEWAY_URL);
        assertThrows(NullPointerException.class, () -> spyFunction.process(payload, context));
    }

    @Test
    void no_tracking_list() {
        String payload = "{\"previous_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"}},\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("700");
        when(context.getUserConfigValueOrDefault(API_GATEWAY_URL, DEFAULT_API_GATEWAY_URL)).thenReturn(DEFAULT_API_GATEWAY_URL);
        assertThrows(NullPointerException.class, () -> spyFunction.process(payload, context));
    }

    @Test
    void gateway_404_error() {
        when(statusLine.getStatusCode()).thenReturn(404);
        String gatewayUrl = "http://unit-test/post";
        String payload = "{\"previous_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"XYZZZZ\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"XYZZZZ\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-10-30T17:50:52.692Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"merged_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"xyzzzz\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"xyzzzz\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-11-02T05:54:19.326Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-11-02T05:54:19.323Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("700");
        when(context.getUserConfigValueOrDefault(API_GATEWAY_URL, DEFAULT_API_GATEWAY_URL)).thenReturn(gatewayUrl);
        assertThrows(BadStatusException.class, () -> spyFunction.process(payload, context));
    }

    @Test
    void gateway_error() throws Exception {
        when(statusLine.getStatusCode()).thenReturn(500);
        String gatewayUrl = "http://unit-test/post";
        String payload = "{\"previous_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"XYZZZZ\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"XYZZZZ\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-10-30T17:50:52.692Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"merged_order_tracking_response\":{\"order\":{\"retailer_moniker\":\"ankurcompany\",\"order_number\":\"1234567\",\"placement_date\":\"2018-11-29T00:00:00Z\",\"billing_document\":{\"billing_address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"{\\\"cipher\\\":\\\"c35d9ffe501757fd79bd956a4fb95d1d520e1205a290ee5af9db7efe977e4c8b\\\",\\\"salt\\\":\\\"67db908d89add4b5\\\"}\",\"zipcode\":\"94107\"},\"billed_to\":{\"first_name\":\"{\\\"cipher\\\":\\\"13a1c39118c4442a1e566e30f0053cff7fd31f920140a00e0f18719b9dac2af3\\\",\\\"salt\\\":\\\"16ca809a470ae50c\\\"}\",\"last_name\":\"{\\\"cipher\\\":\\\"f0592fbcdf7244f89ac5231ecc5bed02db20d7694386d215fefe739281086c76\\\",\\\"salt\\\":\\\"95971946ad7e2a9b\\\"}\",\"phone\":\"{\\\"cipher\\\":\\\"540fbc4028a26cc8192cf99a32714a558c3d2e6f7c19f37abfad458a6f1da814\\\",\\\"salt\\\":\\\"4958715b18468df8\\\"}\",\"email\":\"{\\\"cipher\\\":\\\"00a5d2b882812bf6167b8527e5a3b66890d360ca31dad75974ddf23e76d5a1959c52627f7d125546ce12779d8292e3fb\\\",\\\"salt\\\":\\\"7a347f0a8f705678\\\"}\",\"address\":{\"city\":\"San Francisco\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"633 Folsom St\",\"zipcode\":\"94107\"}}},\"fulfillment_status\":\"SHIPPED\",\"shipment_info\":[{\"id\":\"ankurcompany:1234567\",\"tracking_number\":\"XYZZZZ\",\"items\":[{\"product_sku\":\"5512370\",\"quantity\":1}],\"ship_to\":{\"first_name\":\"Shivani\",\"last_name\":\"K\",\"email\":\"shivani@narvar.com\",\"address\":{\"city\":\"San Jose\",\"country\":\"US\",\"state\":\"CA\",\"street1\":\"125 Riverview Pkwy\",\"zipcode\":\"95134\"}},\"ship_date\":\"2018-10-30 17:35:55.571000\",\"carrier\":\"UPS\",\"carrier_service\":\"UG\",\"ship_method\":\"FL UPS Ground (3-5 Days)\",\"customer_key\":\"9e2fa7f9-e730-327e-a593-5280b4219940\",\"custom_attributes\":{}}],\"items\":[{\"product_sku\":\"5512370\",\"name\":\"Women's adidas Originals 3-Stripes Leggings\",\"price\":\"37.98\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/AJ8156_BLK?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"5512370\",\"custom_attributes\":{\"rma_number\":\"56316DC8873F7182E0532B5E000A7724\",\"color\":\"BLK\",\"size\":\"MED\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"Women's adidas Originals 3-Stripes Leggings\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:5512370\"},{\"product_sku\":\"2156871-1\",\"name\":\"FREE RUN\",\"price\":\"87.11\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":true,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156871-1\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.0\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":1,\"gift\":false,\"id\":\"ankurcompany:1234567:2156871\"},{\"product_sku\":\"2156872-2\",\"name\":\"FREE RUN\",\"price\":\"87.12\",\"image_url\":\"http://images.finishline.com/is/image/FinishLine/831509_002?$shq$\",\"final_sale\":false,\"shop_runner_eligible\":false,\"fulfillment_status\":\"SHIPPED\",\"parent_product_sku\":\"2156872-2\",\"custom_attributes\":{\"rma_number\":\"R0000000000570\",\"color\":\"002\",\"size\":\"6.5\",\"attribute1\":null,\"style\":null,\"attribute2\":null},\"description\":\"FREE RUN\",\"quantity\":10,\"gift\":false,\"id\":\"ankurcompany:1234567:2156872\"}],\"created_date\":\"2018-10-30T15:36:50.940Z\",\"modified_date\":\"2018-10-30T15:36:50.956Z\"},\"tracking\":[{\"carrier_moniker\":\"ups\",\"tracking_number\":\"xyzzzz\",\"current_event_date\":\"2018-11-01T10:15:30Z\",\"current_event_code\":\"700\",\"previous_event_code\":[\"700\"],\"carrier_status_code\":\"OT\",\"delivery\":{\"edd_begin\":\"2018-11-01T10:15:30Z\",\"edd_end\":\"2018-11-01T10:15:30Z\",\"guaranteed_date_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_begin\":\"2018-11-01T10:15:30Z\",\"appointment_window_end\":\"2018-11-01T10:15:30Z\"},\"origin\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"55 W 20th Avenue\",\"street2\":\"Apt 109\",\"zipcode\":\"94401\"},\"dest\":{\"city\":\"San Francisco\",\"country\":\"USA\",\"state\":\"CA\",\"street1\":\"605 E 5th Ave\",\"zipcode\":\"94105\"},\"status_code\":\"DLVD\",\"status_description\":\"Delivered: General\",\"status_token\":\"widgets_tracking_status_delivered_status\",\"events\":[{\"carrier_status_code\":\"DS\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"700\"},{\"carrier_status_code\":\"OT\",\"date\":\"2018-11-01T10:15:30Z\",\"description\":\"Delivered: General\",\"status_code_mapping\":{\"bucket\":\"Delivered\",\"bucket_code\":\"DLVD\",\"bucket_display_token\":\"widgets_tracking_status_delivered_status\",\"code\":\"700\",\"code_description\":\"Delivered: General\",\"display_token\":\"tracking_status_delivered_general\"},\"exception\":{},\"location\":{\"city\":\"San Mateo\",\"country\":\"USA\",\"state\":\"CA\",\"zipcode\":\"94403\",\"lat\":\"17.09\",\"lng\":\"198014.1\"},\"carrier_moniker\":\"ups\",\"raw_code\":\"400\"}],\"source\":\"DB\",\"partner_tracking_number\":\"xyzzzz\",\"signature\":{\"required\":true},\"db_id\":\"ankurcompany:ups:xyzzzz:1234567\",\"retailer_moniker\":\"ankurcompany\",\"created_date\":\"2018-10-30T15:36:51.082Z\",\"modified_date\":\"2018-11-02T05:54:19.326Z\",\"shipper_account_number\":\"13243\",\"audit_log\":[{\"date\":\"2018-10-30T15:36:51.080Z\",\"message_origin\":\"order_api_processor\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:12.078Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T15:37:24.757Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:46:05.349Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T16:47:53.158Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:48:47.728Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-10-30T17:50:52.692Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true},{\"date\":\"2018-11-02T05:54:19.323Z\",\"message_origin\":\"CarrierDataIngestionAPI\",\"audit_record_saved\":true}],\"record_updaters\":[\"order_api_processor\",\"CarrierDataIngestionAPI\"]}]},\"retailer_moniker\":\"ankurcompany\",\"meta_info\":{\"message_origin\":\"CarrierDataIngestionAPI\",\"message_source\":\"ATLAS\",\"message_source_location\":\"IN\",\"message_type\":\"ORDER_TRACKING_RESPONSE\",\"enqueued_date_time\":\"2018-11-02T05:54:19.482Z\"}}";
        when(context.getUserConfigValueOrDefault(EVENT_CODES, DEFAULT_EVENT_CODE)).thenReturn("700");
        when(context.getUserConfigValueOrDefault(API_GATEWAY_URL, DEFAULT_API_GATEWAY_URL)).thenReturn(gatewayUrl);
        Void object = spyFunction.process(payload, context);
        assertNull(object);
    }
}